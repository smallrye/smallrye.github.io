<!DOCTYPE html>
<html>

<head>
  <title>Fault Tolerance 4.0</title>
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlightjs-pack.js" type="text/javascript"></script>
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      https://www.redhat.com
      https://static.redhat.com
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://www.google-analytics.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <META HTTP-EQUIV="X-Frame-Options" CONTENT="DENY">
  <META HTTP-EQUIV="X-XSS-Protection" CONTENT="1; mode=block">
  <META HTTP-EQUIV="X-Content-Type-Options" CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="SmallRye is a project to share and collaborate on implementing specifications that are part of Eclipse MicroProfile.">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
</head>

<body class="post">

  <div class="content">
    <div class="navigation-wrapper">
  <div class="width-12-12">
    <div class="header navigation">
      <div class="logo-wrapper">
        <a href="/"><img class="project-logo" title="SmallRye" src="/assets/images/smallrye_project_logo.svg"></a>
      </div>
      <div class="nav-container">
        <nav>
          <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
          <ul class="nav-list">
            <li>
              <a href="/projects/" class="">Projects</a>
            </li>
            <li>
              <a href="/community/" class="">Community</a>
            </li>
            <li>
              <a href="/blog/" class="active">Blog</a>
            </li>
            <li>
              <a href="/docs/index.html" class="">Documentation</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

    <div class="post-page grid-wrapper">
  <div class="grid__item width-10-12 doc-content">
    <h1>Fault Tolerance 4.0</h1>
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/smallrye/smallrye-fault-tolerance">SmallRye Fault Tolerance</a> is our implementation of <a href="https://github.com/eclipse/microprofile-fault-tolerance">Eclipse MicroProfile Fault Tolerance</a>.
It was originally based on <a href="https://github.com/Netflix/Hystrix">Hystrix</a>, the Netflix library for latency and fault tolerance in distributed systems.
Lately, we realized that Hystrix is not the best fit for implementing MicroProfile Fault Tolerance, because Hystrix meshes all fault tolerance concerns into one, while MicroProfile Fault Tolerance describes mostly a layered architecture.
The MicroProfile Fault Tolerance specification also requires certain features that Hystrix intentionally doesn&#8217;t provide; most importantly, the ability to interrupt threads that Hystrix itself didn&#8217;t create.
Last but not least, Hystrix is in maintenance mode, and hasn&#8217;t been actively developed for more than a year.
When we tried to update to latest Hystrix version, we even faced breaking changes.</p>
</div>
<div class="paragraph">
<p>We have been talking on and off about removing Hystrix and using our own implementation of core fault tolerance strategies, one that would be better suited as a base for implementing MicroProfile Fault Tolerance, but only a few months ago did we finally start working on it.
Thanks to heroic work of <a href="https://github.com/michalszynkiewicz">Micha≈Ç Szynkiewicz</a>, the new implementation didn&#8217;t take long to pass the entire MicroProfile Fault Tolerance TCK.
We have already released a first version of this new implementation, called 4.0.0.
Of course, that&#8217;s not the end; in fact, it&#8217;s just a beginning.
We should now have a better foundation to experiment with, and already have several ideas that we would like to explore and eventually propose to MicroProfile Fault Tolerance.</p>
</div>
<div class="paragraph">
<p>In this article, we&#8217;ll take a brief look at how the new implementation works inside, what do you need to know as an integrator, and what are our plans for the future.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="under_the_hood">Under the hood</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, let&#8217;s take a brief look at the core.
It is based on the idea of <code>FaultToleranceStrategy</code>, which is an interface that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface FaultToleranceStrategy&lt;V&gt; {
    V apply(InvocationContext&lt;V&gt; ctx) throws Exception;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>InvocationContext</code> is a <code>Callable</code> that represents the method invocation guarded by this fault tolerance strategy.
The fault tolerance strategy does its work around <code>ctx.call()</code>.
It can catch exceptions, invoke <code>ctx.call()</code> multiple times, invoke something else, etc.
As an example, let&#8217;s consider this strategy, applicable to methods that return a <code>String</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MyStringFallback implements FaultToleranceStrategy&lt;String&gt; {
    @Override
    public String apply(InvocationContext&lt;String&gt; ctx) {
        try {
            return ctx.call();
        } catch (Exception ignored) {
            return "my string value";
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a very simple fallback mechanism, which returns a pre-defined value in case of an exception.</p>
</div>
<div class="paragraph">
<p>In the SmallRye Fault Tolerance codebase, you can find implementations of all the strategies required by MicroProfile Fault Tolerance: retry, fallback, timeout, circuit breaker or bulkhead.
Asynchronous invocation, delegated to a thread pool, is of course also supported.</p>
</div>
<div class="paragraph">
<p>When multiple fault tolerance strategies are supposed to be used to guard one method, they form a chain.
Continuing with our simple example, adding the ability to chain with another strategy would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MyStringFallback implements FaultToleranceStrategy&lt;String&gt; {
    private final FaultToleranceStrategy&lt;String&gt; delegate;

    public MyStringFallback(FaultToleranceStrategy&lt;String&gt; delegate) {
        this.delegate = delegate;
    }

    @Override
    public String apply(InvocationContext&lt;String&gt; ctx) {
        try {
            return delegate.apply(ctx);
        } catch (Exception ignored) {
            return "my string value";
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that one strategy delegates to another, passing the <code>InvocationContext</code> along.
In fact, all the implementations in SmallRye Fault Tolerance are written like this: they expect to be used in a chain, so they take another <code>FaultToleranceStrategy</code> to which they delegate.
But if all strategies have this form, when is <code>ctx.call()</code> actually invoked?
Good question!
The ultimate <code>ctx.call()</code> invocation is done by a special fault tolerance strategy which is called, well, <code>Invocation</code>.</p>
</div>
<div class="paragraph">
<p>As an example which uses real MicroProfile Fault Tolerance annotations, let&#8217;s consider this method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Retry(...)
@Timeout(...)
@Fallback(...)
public void doSomething() {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The chain of fault tolerance strategies will look roughly like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Fallback(
    Retry(
        Timeout(
            Invocation(
                // ctx.call() will happen here
                // that will, in turn, invoke doSomething()
            )
        )
    )
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The order in which the strategies are chained (or, in fact, nested) is specified by MicroProfile Fault Tolerance.</p>
</div>
<div class="paragraph">
<p>In asynchronous invocations, especially those using <code>CompletionStage</code>, it is a bit more complex, but the core idea is the same and the intuition you gained here should still apply.</p>
</div>
<div class="paragraph">
<p>Please note that everything explained here is an implementation detail.
API stability for these interfaces and classes is <em>not</em> guaranteed; we only mention them here to give you better understanding of the new implementation.
You will also want to understand this if you decide to contribute (pull requests are always welcome!).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integration_concerns">Integration concerns</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you integrate SmallRye Fault Tolerance to provide an implementation of MicroProfile Fault Tolerance, you should be aware of a few things.</p>
</div>
<div class="paragraph">
<p>SmallRye Fault Tolerance creates several thread pools (<code>ExecutorService</code>s).
One for asynchronous invocations, one for watching timeouts, and then one for each threadpool-style bulkhead.
You might want to customize how these thread pools are created.
For example, if you integrate SmallRye Fault Tolerance into a Java EE application server, you probably want these thread pools to be managed.
We provide an SPI that you can implement for this exact purpose: <a href="https://github.com/smallrye/smallrye-fault-tolerance/blob/main/implementation/fault-tolerance/src/main/java/io/smallrye/faulttolerance/ExecutorFactory.java"><code>ExecutorFactory</code></a>.</p>
</div>
<div class="paragraph">
<p>Size of these thread pools can be configured using the following configuration properties:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>io.smallrye.faulttolerance.globalThreadPoolSize</code></dt>
<dd>
<p>Size of the thread pool for asynchronous invocations.
Does not include bulkhead thread pools.
Defaults to 100.</p>
</dd>
<dt class="hdlist1"><code>io.smallrye.faulttolerance.timeoutExecutorThreads</code></dt>
<dd>
<p>Size of the thread pool for watching timeouts.
Defaults to 5.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Optional integration with <a href="https://github.com/eclipse/microprofile-context-propagation">MicroProfile Context Propagation</a> is present, in a separate artifact.
Optional integration with <a href="https://github.com/eclipse/microprofile-opentracing">MicroProfile OpenTracing</a> is also present, but it&#8217;s currently built on top of the Context Propagation integration.
We&#8217;re looking to potentially remove that dependency, so that OpenTracing integration is also possible if you&#8217;re not yet ready to incorporate Context Propagation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="future_outlook">Future outlook</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we mentioned above, this is not an end.
Here&#8217;s a short list of what we want to look at.</p>
</div>
<div class="paragraph">
<p>First of all, the 4.0 version implements MicroProfile Fault Tolerance 2.0.
We will of course continue implementing subsequent specification versions, starting with 2.1, which should be released soon.</p>
</div>
<div class="paragraph">
<p>Currently, MicroProfile Fault Tolerance specifies that <code>@Asynchronous</code> invocation always means delegating to a thread pool.
We&#8217;d like to investigate what would it take to support asynchronous invocation on an event loop, such as one provided by Vert.x.</p>
</div>
<div class="paragraph">
<p>We&#8217;d like to add a <a href="https://github.com/eclipse/microprofile-fault-tolerance/issues/475">fail-fast strategy</a>, tentatively called <code>@FailFast</code>.
This is useful to prevent expensive calls when you know it doesn&#8217;t make sense to do them.
One instance of this idea is the circuit breaker, which decides automatically based on rate of errors.
Here, the decision would be entirely yours.</p>
</div>
<div class="paragraph">
<p>We&#8217;d also like to add <a href="https://github.com/eclipse/microprofile-fault-tolerance/issues/474">adaptive concurrency limiters</a>, tentatively called <code>@AdaptiveBulkhead</code>.
Bulkheads, as they exist in MicroProfile Fault Tolerance now, are defined statically.
That is, you need to know upfront what is the maximum concurrency level.
This is no longer enough in the cloud world, where services are scaled up and down dynamically.
It is possible to determine the concurrency limits dynamically, by observing the invocation latencies and error rates.
Netflix has been doing that in their <a href="https://github.com/Netflix/concurrency-limits">concurrency limits</a> project, and we can certainly take a lot of inspiration from them.</p>
</div>
<div class="paragraph">
<p>Some of the items above are about providing a new API.
The idea is that we would prototype that API in SmallRye and if it proves worthy, we&#8217;d work to specify it in MicroProfile.
For that reason, we would probably mark these prototypes as experimental API, and if they get specified in MicroProfile, we&#8217;d rapidly deprecate and remove them.</p>
</div>
<div class="paragraph">
<p>There are also some implementation aspects that we&#8217;d like to finetune.</p>
</div>
<div class="paragraph">
<p>The metrics collection and configuration handling code mostly comes from the old implementation, and is due for serious refactoring.</p>
</div>
<div class="paragraph">
<p>As mentioned above, each threadpool-style bulkhead currently gets a fresh thread pool.
This is quite inefficient, and can be significantly improved.</p>
</div>
<div class="paragraph">
<p>The current implementation includes a special strategy called <code>Tracer</code>, which can be put in between any two other strategies to print useful information about when and on which thread is the subsequent strategy invoked.
This proved very useful in debugging, but using it requires manual changes and rebuild of the entire codebase.
We want to add comprehensive debug and trace logging that is always present, so that you can easily enable it.</p>
</div>
<div class="paragraph">
<p>And there&#8217;s a lot more, for sure.
As we said above, this is just a beginning!</p>
</div>
</div>
</div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/smallrye_project_logo.svg" class="project-logo" title="SmallRye"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">SmallRye is open source under <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>. <br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/smallrye/smallrye.github.io' target='_blank'>fork the website</a> and show us what you‚Äôve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="/">Home</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://twitter.com/smallrye_io">Follow us</a></li>
          
            <li><a href="https://github.com/smallrye">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://quarkusio.zulipchat.com">Chatroom</a></li>
          
            <li><a href="https://groups.google.com/d/forum/smallrye">Google&nbsp;Groups</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <span>External Links</span>
        <ul class="footer-links">
          
            <li><a href="https://microprofile.io/" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://github.com/eclipse?utf8=‚úì&q=microprofile" target="_blank">Eclipse MicroProfile on GitHub</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
      | <a href="https://www.redhat.com/en/about/privacy-policy">Red Hat Privacy Policy</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script type="text/javascript" src="/assets/javascript/satellite.js"></script>
</body>

</html>
