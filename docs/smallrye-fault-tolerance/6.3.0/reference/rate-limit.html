<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rate Limit :: SmallRye documentation</title>
    <link rel="prev" href="asynchronous.html">
    <link rel="next" href="config.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <button class="nav-toggle"></button>

      <a class="navbar-item title" href="../index.html">SmallRye Fault Tolerance</a>

      <div class="navbar-item has-dropdown is-hoverable">
        <span class="navbar-link">6.3.0</span>
        <div class="navbar-dropdown navbar-menu">
            <a class="navbar-item " href="../../6.9.1/index.html">6.9.1</a>
            <a class="navbar-item " href="../../6.9.0/index.html">6.9.0</a>
            <a class="navbar-item " href="../../6.8.0/index.html">6.8.0</a>
            <a class="navbar-item " href="../../6.7.3/index.html">6.7.3</a>
            <a class="navbar-item " href="../../6.7.2/index.html">6.7.2</a>
            <a class="navbar-item " href="../../6.7.1/index.html">6.7.1</a>
            <a class="navbar-item " href="../../6.7.0/index.html">6.7.0</a>
            <a class="navbar-item " href="../../6.6.3/index.html">6.6.3</a>
            <a class="navbar-item " href="../../6.6.2/index.html">6.6.2</a>
            <a class="navbar-item " href="../../6.6.1/index.html">6.6.1</a>
            <a class="navbar-item " href="../../6.6.0/index.html">6.6.0</a>
            <a class="navbar-item " href="../../6.5.0/index.html">6.5.0</a>
            <a class="navbar-item " href="../../6.4.3/index.html">6.4.3</a>
            <a class="navbar-item " href="../../6.4.2/index.html">6.4.2</a>
            <a class="navbar-item " href="../../6.4.1/index.html">6.4.1</a>
            <a class="navbar-item " href="../../6.4.0/index.html">6.4.0</a>
            <a class="navbar-item  is-current" href="../index.html">6.3.0</a>
            <a class="navbar-item " href="../../6.2.6/index.html">6.2.6</a>
            <a class="navbar-item " href="../../6.2.4/index.html">6.2.4</a>
            <a class="navbar-item " href="../../6.2.3/index.html">6.2.3</a>
            <a class="navbar-item " href="../../6.2.2/index.html">6.2.2</a>
            <a class="navbar-item " href="../../6.2.1/index.html">6.2.1</a>
            <a class="navbar-item " href="../../6.2.0/index.html">6.2.0</a>
            <a class="navbar-item " href="../../6.1.0/index.html">6.1.0</a>
            <a class="navbar-item " href="../../6.0.0/index.html">6.0.0</a>
            <a class="navbar-item " href="../../5.6.0/index.html">5.6.0</a>
            <a class="navbar-item " href="../../5.5.0/index.html">5.5.0</a>
            <a class="navbar-item " href="../../5.4.1/index.html">5.4.1</a>
            <a class="navbar-item " href="../../5.4.0/index.html">5.4.0</a>
            <a class="navbar-item " href="../../5.3.2/index.html">5.3.2</a>
            <a class="navbar-item " href="../../5.3.1/index.html">5.3.1</a>
            <a class="navbar-item " href="../../5.3.0/index.html">5.3.0</a>
            <a class="navbar-item " href="../../5.2.1/index.html">5.2.1</a>
            <a class="navbar-item " href="../../5.2.0/index.html">5.2.0</a>
            <a class="navbar-item " href="../../5.1.0/index.html">5.1.0</a>
            <a class="navbar-item " href="../../5.0.0/index.html">5.0.0</a>
        </div>
      </div>


      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <span class="navbar-link">Projects</span>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="../../../index/index/index.html">Index</a>
              <a class="navbar-item" href="../../6.9.1/index.html">SmallRye Fault Tolerance</a>
              <a class="navbar-item" href="../../../smallrye-health/3.0.1/index.html">SmallRye Health</a>
              <a class="navbar-item" href="../../../smallrye-jwt/index.html">SmallRye JWT</a>
              <a class="navbar-item" href="../../../smallrye-metrics/3.0.0/index.html">SmallRye Metrics</a>
          </div>
        </div>

        <a class="navbar-item" href="https://smallrye.io/">SmallRye.io main website</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="smallrye-fault-tolerance" data-version="6.3.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list nav-list-level-0">
  <li class="nav-item nav-item-level-0">
<ul class="nav-list nav-list-level-1">
  <li class="nav-item nav-item-level-1">
    <a class="nav-link" href="../index.html">Index</a>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">How-to &#8230;&#8203;</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/begin.html">Begin</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/fallback.html">Supply Fallback Values</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/bulkhead.html">Limit Concurrency</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/circuit-breaker.html">Fail Fast on Recurring Failures</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/timeout.html">Watch for Timeouts</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/retry.html">Retry on Failures</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/asynchronous.html">Guard Asynchronous Methods</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/rate-limit.html">Limit Execution Rate</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../howto/multiple.html">Use Multiple Strategies</a>
  </li>
</ul>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">Reference</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="fallback.html">Fallback</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="bulkhead.html">Bulkhead</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="circuit-breaker.html">Circuit Breaker</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="timeout.html">Timeout</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="retry.html">Retry</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="asynchronous.html">Asynchronous Execution</a>
  </li>
  <li class="nav-item nav-item-level-2 is-current-page">
    <a class="nav-link" href="rate-limit.html">Rate Limit</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="config.html">Configuration</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="metrics.html">Metrics</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="non-compat.html">Non-compatible Mode</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="programmatic-api.html">Programmatic API</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="reusable.html">Reusable Fault Tolerance</a>
  </li>
</ul>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">Integration</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/intro.html">Introduction</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/metrics.html">Metrics</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/thread-pool.html">Thread Pool</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/context-propagation.html">Context Propagation</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/opentracing.html">OpenTracing</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/event-loop.html">Event Loop</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/async-types.html">Additional Asynchronous Types Integration Concerns</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/kotlin.html">Kotlin Integration Concerns</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/programmatic-api.html">Programmatic API Integration Concerns</a>
  </li>
</ul>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">Internals</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/project-structure.html">Project Structure</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/instructions.html">Instructions</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/core.html">Fault Tolerance Core</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/config.html">Configuration System</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/logging.html">Logging</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
  <div class="content">
<aside class="toc sidebar" data-title="Table of contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
  <a href="https://github.com/smallrye/smallrye-fault-tolerance/blob/6.3.0/doc/modules/ROOT/pages/reference/rate-limit.adoc" class="edit-this-page" title="Edit this page">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>
<h1 class="page">Rate Limit</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>For introduction, see <a href="../howto/rate-limit.html" class="page">How to Limit Execution Rate</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is an additional feature of SmallRye Fault Tolerance and is not specified by MicroProfile Fault Tolerance.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_description"><a class="anchor" href="#_description"></a>Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rate limit enforces a maximum number of permitted invocations in a time window of some length.
For example, with a rate limit, one can make sure that a method may only be called 50 times per minute.
Invocations that would exceed the limit are rejected with an exception of type <code>RateLimitException</code>.</p>
</div>
<div class="paragraph">
<p>Additionally, it is possible to define minimum spacing between invocations.
For example, with minimum spacing of 1 second, if a second invocation happens 500 millis after the first, it is rejected even if the limit would not be exceeded yet.</p>
</div>
<div class="paragraph">
<p>Rate limit is superficially similar to a bulkhead (concurrency limit), but is in fact quite different.
Bulkhead limits the number of executions happening concurrently at any point in time.
Rate limit limits the number of executions in a time window of some length, without considering concurrency.</p>
</div>
<div class="paragraph">
<p>A method or a class can be annotated with <code>@RateLimit</code>, which means the method or the methods in the class will apply the rate limit strategy.
The previous example with 50 maximum invocations per minute and minimum spacing of 1 second would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RateLimit(value = 50,
        window = 1, windowUnit = ChronoUnit.MINUTES,
        minSpacing = 1, minSpacingUnit = ChronoUnit.SECONDS)
public void doSomething() {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>RateLimitException</code> class has a method <code>getRetryAfterMillis()</code> which returns the number of milliseconds after which the user may retry the rejected invocation.
Retrying sooner is guaranteed to be rejected again.
Note that this information is accurate only at the time the invocation is rejected.
It may be invalidated by any subsequent or concurrent invocations, so there is no guarantee that a retry attempt after the given number of milliseconds will in fact be permitted.</p>
</div>
<div class="sect2">
<h3 id="_lifecycle"><a class="anchor" href="#_lifecycle"></a>Lifecycle</h3>
<div class="paragraph">
<p>Rate limit needs to maintain some state between invocations: the number of recent invocations, the time stamp of last invocation, and so on.
This state is a singleton, irrespective of the lifecycle of the bean that uses the <code>@RateLimit</code> annotation.</p>
</div>
<div class="paragraph">
<p>More specifically, the rate limit state is uniquely identified by the combination of the bean class (<code>java.lang.Class</code>) and the method object (<code>java.lang.reflect.Method</code>) representing the guarded method.</p>
</div>
<div class="paragraph">
<p>For example, if thereâ€™s a guarded method <code>doWork</code> on a bean which is <code>@RequestScoped</code>, each request will have its own instance of the bean, but all invocations of <code>doWork</code> will share the same rate limit state.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interactions"><a class="anchor" href="#interactions"></a>Interactions with Other Strategies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>See <a href="../howto/multiple.html" class="page">How to Use Multiple Strategies</a> for an overview of how fault tolerance strategies are nested.</p>
</div>
<div class="paragraph">
<p>If <code>@Fallback</code> is used with <code>@RateLimit</code>, the fallback method or handler may be invoked if a <code>RateLimitException</code> is thrown, depending on the fallback configuration.</p>
</div>
<div class="paragraph">
<p>If <code>@Retry</code> is used with <code>@RateLimit</code>, each retry attempt is processed by the rate limit as an independent invocation.
If <code>RateLimitException</code> is thrown, the execution may be retried, depending on how retry is configured.</p>
</div>
<div class="paragraph">
<p>If <code>@CircuitBreaker</code> is used with <code>@RateLimit</code>, the circuit breaker is checked before enforcing the rate limit.
If rate limiting results in <code>RateLimitException</code>, this may be counted as a failure, depending on how the circuit breaker is configured.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are 6 configuration options, corresponding to the 6 members of the <code>@RateLimit</code> annotation.</p>
</div>
<div class="sect2">
<h3 id="_value"><a class="anchor" href="#_value"></a><code>value</code></h3>
<div class="paragraph">
<p>Type: <code>int</code></p>
</div>
<div class="paragraph">
<p>Default: <code>100</code></p>
</div>
<div class="paragraph">
<p>The limit of maximum invocations to be permitted in the time window.</p>
</div>
</div>
<div class="sect2">
<h3 id="_window_windowunit"><a class="anchor" href="#_window_windowunit"></a><code>window</code> + <code>windowUnit</code></h3>
<div class="paragraph">
<p>Type: <code>long</code> + <code>ChronoUnit</code></p>
</div>
<div class="paragraph">
<p>Default: <code>1 second</code></p>
</div>
<div class="paragraph">
<p>The length of the time window.</p>
</div>
</div>
<div class="sect2">
<h3 id="_minspacing_minspacingunit"><a class="anchor" href="#_minspacing_minspacingunit"></a><code>minSpacing</code> + <code>minSpacingUnit</code></h3>
<div class="paragraph">
<p>Type: <code>long</code> + <code>ChronoUnit</code></p>
</div>
<div class="paragraph">
<p>Default: <code>0 seconds</code></p>
</div>
<div class="paragraph">
<p>The minimum spacing between two consecutive invocations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_type"><a class="anchor" href="#_type"></a><code>type</code></h3>
<div class="paragraph">
<p>Type: <code>RateLimitType</code></p>
</div>
<div class="paragraph">
<p>Default: <code>RateLimitType.FIXED</code></p>
</div>
<div class="paragraph">
<p>The type of time window used for rate limiting.
There are 3 types of time windows used for rate limiting: <em>fixed</em>, <em>rolling</em> and <em>smooth</em>.</p>
</div>
<div class="paragraph">
<p>Fixed time windows are a result of dividing time into non-overlapping intervals of given length.
The invocation limit is enforced for each interval independently.
This means that short bursts of invocations occuring near the time window boundaries may temporarily exceed the configured rate limit.
This kind of rate limiting is also called <em>fixed window</em> rate limiting.</p>
</div>
<div class="paragraph">
<p>Rolling time windows enforce the limit continuously, instead of dividing time into independent intervals.
The invocation limit is enforced for all possible time intervals of given length, regardless of overlap.
This is more precise, but requires more memory and may be slower.
This kind of rate limiting is also called <em>sliding log</em> rate limiting.</p>
</div>
<div class="paragraph">
<p>Smooth time windows enforce a uniform distribution of invocations under a rate calculated from given time window length and given limit.
If recent rate of invocations is under the limit, a subsequent burst of invocations is allowed during a shorter time span, but the calculated rate is never exceeded.
This kind of rate limiting is also called <em>token bucket</em> or <em>leaky bucket (as a meter)</em> rate limiting, with the additional property that all work units are considered to have the same size.</p>
</div>
<div class="paragraph">
<p>With fixed and rolling time windows, rejected invocations always count towards the limit, so if a caller continuously invokes the guarded method faster than the configuration allows, all invocations are rejected until the caller slows down.
With smooth time windows, rejected invocations do not count towards the recent rate of invocations.</p>
</div>
<div class="paragraph">
<p>Example usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RateLimit(value = 50,
        window = 1, windowUnit = ChronoUnit.MINUTES,
        minSpacing = 1, minSpacingUnit = ChronoUnit.SECONDS,
        type = RateLimitType.ROLLING)
public void doSomething() {
    ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="metrics"><a class="anchor" href="#metrics"></a>Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rate limit exposes the following metrics:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ft.ratelimit.calls.total</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Counter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of times the rate limit logic was run. This is usually once per method call, but may be zero times if the circuit breaker prevented execution or more than once if the method call was retried.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tags</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>method</code> - the fully qualified method name</p>
</li>
<li>
<p><code>rateLimitResult</code> = <code>[permitted|rejected]</code> - whether the rate limit permitted the method call</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See <a href="metrics.html" class="page">the Metrics reference guide</a> for general metrics information.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="asynchronous.html">Asynchronous Execution</a></span>
  <span class="next"><a href="config.html">Configuration</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>
    Sponsored by <a href="https://www.redhat.com"><img style="vertical-align: middle; height: 2.5em;" src="../../../_/img/redhat.svg" alt="Red Hat"></a>
  </p>
  <p>
    Made with <a href="https://github.com/smallrye/smallrye-antora-ui">SmallRye Antora UI</a>, which is licensed under the MPL-2.0 license.
    Includes portions of <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a>, which is licensed under the MIT license.
  </p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
