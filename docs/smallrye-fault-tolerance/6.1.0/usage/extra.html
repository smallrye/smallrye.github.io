<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Extra Features :: SmallRye documentation</title>
    <link rel="prev" href="basic.html">
    <link rel="next" href="programmatic-api.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <button class="nav-toggle"></button>

      <a class="navbar-item title" href="../index.html">SmallRye Fault Tolerance</a>

      <div class="navbar-item has-dropdown is-hoverable">
        <span class="navbar-link">6.1.0</span>
        <div class="navbar-dropdown navbar-menu">
            <a class="navbar-item " href="../../6.2.4/index.html">6.2.4</a>
            <a class="navbar-item " href="../../6.2.3/index.html">6.2.3</a>
            <a class="navbar-item " href="../../6.2.2/index.html">6.2.2</a>
            <a class="navbar-item " href="../../6.2.1/index.html">6.2.1</a>
            <a class="navbar-item " href="../../6.2.0/index.html">6.2.0</a>
            <a class="navbar-item  is-current" href="../index.html">6.1.0</a>
            <a class="navbar-item " href="../../6.0.0/index.html">6.0.0</a>
            <a class="navbar-item " href="../../5.6.0/index.html">5.6.0</a>
            <a class="navbar-item " href="../../5.5.0/index.html">5.5.0</a>
            <a class="navbar-item " href="../../5.4.1/index.html">5.4.1</a>
            <a class="navbar-item " href="../../5.4.0/index.html">5.4.0</a>
            <a class="navbar-item " href="../../5.3.2/index.html">5.3.2</a>
            <a class="navbar-item " href="../../5.3.1/index.html">5.3.1</a>
            <a class="navbar-item " href="../../5.3.0/index.html">5.3.0</a>
            <a class="navbar-item " href="../../5.2.1/index.html">5.2.1</a>
            <a class="navbar-item " href="../../5.2.0/index.html">5.2.0</a>
            <a class="navbar-item " href="../../5.1.0/index.html">5.1.0</a>
            <a class="navbar-item " href="../../5.0.0/index.html">5.0.0</a>
        </div>
      </div>


      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <span class="navbar-link">Projects</span>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="../../../index/index/index.html">Index</a>
              <a class="navbar-item" href="../../6.2.4/index.html">SmallRye Fault Tolerance</a>
              <a class="navbar-item" href="../../../smallrye-health/3.0.1/index.html">SmallRye Health</a>
              <a class="navbar-item" href="../../../smallrye-jwt/index.html">SmallRye JWT</a>
              <a class="navbar-item" href="../../../smallrye-metrics/3.0.0/index.html">SmallRye Metrics</a>
          </div>
        </div>

        <a class="navbar-item" href="https://smallrye.io/">SmallRye.io main website</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="smallrye-fault-tolerance" data-version="6.1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list nav-list-level-0">
  <li class="nav-item nav-item-level-0">
<ul class="nav-list nav-list-level-1">
  <li class="nav-item nav-item-level-1">
    <a class="nav-link" href="../index.html">Index</a>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">Usage</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="basic.html">Basic Usage</a>
  </li>
  <li class="nav-item nav-item-level-2 is-current-page">
    <a class="nav-link" href="extra.html">Extra Features</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="programmatic-api.html">Programmatic API</a>
  </li>
</ul>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">Integration</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/intro.html">Introduction</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/metrics.html">Metrics</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/thread-pool.html">Thread Pool</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/context-propagation.html">Context Propagation</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/opentracing.html">OpenTracing</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/event-loop.html">Event Loop</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/async-types.html">Additional Asynchronous Types Integration Concerns</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/kotlin.html">Kotlin Integration Concerns</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../integration/programmatic-api.html">Programmatic API Integration Concerns</a>
  </li>
</ul>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">Internals</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/project-structure.html">Project Structure</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/instructions.html">Instructions</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/core.html">Fault Tolerance Core</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/config.html">Configuration System</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../internals/logging.html">Logging</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
  <div class="content">
<aside class="toc sidebar" data-title="Table of contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
  <a href="https://github.com/smallrye/smallrye-fault-tolerance/blob/6.1.0/doc/modules/ROOT/pages/usage/extra.adoc" class="edit-this-page" title="Edit this page">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>
<h1 class="page">Extra Features</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>SmallRye Fault Tolerance provides several features that are not present in the MicroProfile Fault Tolerance specification.
Their public API is present in the <code>io.smallrye:smallrye-fault-tolerance-api</code> artifact.</p>
</div>
<div class="paragraph">
<p>Note that these features may have experimental status, marked by the <code>@Experimental</code> annotation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_circuit_breaker_maintenance"><a class="anchor" href="#_circuit_breaker_maintenance"></a>Circuit Breaker Maintenance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is sometimes useful to see the circuit breaker status from within the application, or reset it to the initial state.
This is possible in two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Give the circuit breaker a name by annotating the guarded method with <code>@CircuitBreakerName</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @CircuitBreaker
    @CircuitBreakerName("hello-cb") <i class="conum" data-value="1"></i><b>(1)</b>
    public String hello() {
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The circuit breaker guarding the <code>MyService.hello</code> method is given a name <code>hello-cb</code>.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Inject <code>CircuitBreakerMaintenance</code> and call its methods:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class Example {
    @Inject
    CircuitBreakerMaintenance maintenance;

    public void test() {
        System.out.println("Circuit breaker state: "
            + maintenance.currentState("hello-cb")); <i class="conum" data-value="1"></i><b>(1)</b>
        maintenance.resetAll(); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtains current circuit breaker state.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Resets all circuit breakers to the initial state.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>CircuitBreakerMaintenance</code> interface provides 4 methods:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>currentState(name)</code>: returns current state of given circuit breaker.
The return type <code>CircuitBreakerState</code> is an <code>enum</code> with 3 values: <code>CLOSED</code>, <code>OPEN</code>, <code>HALF_OPEN</code>.</p>
<div class="ulist">
<ul>
<li>
<p><code>onStateChange(name, callback)</code>: registers a callback that will be called when given circuit breaker changes state.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>reset(name)</code>: resets given circuit breaker to the initial state.</p>
</li>
<li>
<p><code>resetAll()</code>: resets all circuit breakers in the application to the initial state.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>See the javadoc of those methods for more information.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="async-nonblocking"><a class="anchor" href="#async-nonblocking"></a>@AsynchronousNonBlocking</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the MicroProfile Fault Tolerance <code>@Asynchronous</code> annotation, SmallRye Fault Tolerance offers an annotation for asynchronous non-blocking processing: <code>@AsynchronousNonBlocking</code>.</p>
</div>
<div class="paragraph">
<p>This annotation may only be placed on methods that return <code>CompletionStage</code>, because the <code>Future</code> type can&#8217;t really be used for non-blocking processing.
It may also be placed on a class, in which case all business methods must return <code>CompletionStage</code>.</p>
</div>
<div class="paragraph">
<p>As opposed to <code>@Asynchronous</code>, the <code>@AsynchronousNonBlocking</code> annotation does <em>not</em> offload the method execution to another thread.
The method is allowed to proceed on the original thread, assuming that it returns quickly and all processing it does is performed in a non-blocking way.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Method return type</th>
<th class="tableblock halign-left valign-top">Execution</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Asynchronous</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Future</code> or <code>CompletionStage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">offloaded to a thread pool</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@AsynchronousNonBlocking</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CompletionStage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">proceeds on the original thread</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_when_to_use_asynchronous"><a class="anchor" href="#_when_to_use_asynchronous"></a>When to Use @Asynchronous</h3>
<div class="paragraph">
<p>Use <code>@Asynchronous</code> if the method has blocking logic, but you don’t want to block the caller thread.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Retry
    @Asynchronous <i class="conum" data-value="1"></i><b>(1)</b>
    CompletionStage&lt;String&gt; hello() {
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using the <code>@Asynchronous</code> annotation, because the method blocks, and it is necessary to offload its execution to another thread.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The thread pool that is used for offloading method calls is provided by the runtime that integrates SmallRye Fault Tolerance.</p>
</div>
</div>
<div class="sect2">
<h3 id="_when_to_use_asynchronousnonblocking"><a class="anchor" href="#_when_to_use_asynchronousnonblocking"></a>When to Use @AsynchronousNonBlocking</h3>
<div class="paragraph">
<p>Use <code>@AsynchronousNonBlocking</code> if the method <em>does not</em> have blocking logic, and you want the execution to stay on the caller thread.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Retry
    @AsynchronousNonBlocking <i class="conum" data-value="1"></i><b>(1)</b>
    CompletionStage&lt;String&gt; hello() {
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using the <code>@AsynchronousNonBlocking</code> annotation, because the method does not block and offloading execution to another thread is not necessary.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the guarded method uses <code>@Retry</code> and some delay between retries is configured, only the initial execution is guaranteed to occur on the original thread.
Subsequent attempts may be offloaded to an extra thread, so that the original thread is not blocked on the delay.</p>
</div>
<div class="paragraph">
<p>If the guarded method uses <code>@Bulkhead</code>, the execution is <em>not</em> guaranteed to occur on the original thread.
If the execution has to wait in the bulkhead queue, it may later end up on a different thread.</p>
</div>
<div class="paragraph">
<p>If the original thread is an event loop thread and event loop integration is enabled, then the event loop is always used to execute the guarded method.
In such case, all retry attempts and queued bulkhead executions are guaranteed to happen on the original thread.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_combine_them"><a class="anchor" href="#_how_to_combine_them"></a>How to Combine Them</h3>
<div class="paragraph">
<p>When these annotations are combined, an annotation on a method has priority over an annotation on a class.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
@AsynchronousNonBlocking
public class MyService {
    @Retry
    CompletionStage&lt;String&gt; hello() { <i class="conum" data-value="1"></i><b>(1)</b>
        ...
    }

    @Retry
    @Asynchronous
    CompletionStage&lt;String&gt; helloBlocking() { <i class="conum" data-value="2"></i><b>(2)</b>
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Treated as <code>@AsynchronousNonBlocking</code>, based on the class annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Treated as <code>@Asynchronous</code>, the method annotation has priority over the class annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is an error to put both <code>@Asynchronous</code> and <code>@AsynchronousNonBlocking</code> on the same program element.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recommendation"><a class="anchor" href="#_recommendation"></a>Recommendation</h3>
<div class="paragraph">
<p>Use the <a href="#method-asynchrony">non-compatible mode</a>.
In this mode, methods returning <code>CompletionStage</code> are automatically treated as if they were <code>@AsynchronousNonBlocking</code>.
Use <code>@Asynchronous</code> to mark blocking methods for thread offload.</p>
</div>
<div class="paragraph">
<p>If you can&#8217;t use the non-compatible mode, use <code>@AsynchronousNonBlocking</code> or <code>@Asynchronous</code> to mark all asynchronous methods.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In previous releases, SmallRye Fault Tolerance recommended to use the <code>@Blocking</code> and <code>@NonBlocking</code> annotations.
Using these annotations <strong>for fault tolerance purposes</strong> is now deprecated.
They are still supported, but at some point, SmallRye Fault Tolerance will stop recognizing them.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also recommend avoiding <code>@Asynchronous</code> methods that return <code>Future</code>, because the only way to obtain the future value is blocking.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="async-types"><a class="anchor" href="#async-types"></a>Additional Asynchronous Types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MicroProfile Fault Tolerance supports asynchronous fault tolerance for methods that return <code>CompletionStage</code>.
(The <code>Future</code> type is not truly asynchronous, so we won&#8217;t take it into account here.)
SmallRye Fault Tolerance adds support for additional asynchronous types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mutiny: <code>Uni</code></p>
</li>
<li>
<p>RxJava: <code>Single</code>, <code>Maybe</code>, <code>Completable</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These types are treated just like <code>CompletionStage</code>, so everything that works for <code>CompletionStage</code> works for these types as well.
Stream-like types (<code>Multi</code>, <code>Observable</code>, <code>Flowable</code>) are not supported, because their semantics can&#8217;t be easily expressed in terms of <code>CompletionStage</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Retry
    @AsynchronousNonBlocking <i class="conum" data-value="1"></i><b>(1)</b>
    Uni&lt;String&gt; hello() { <i class="conum" data-value="2"></i><b>(2)</b>
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using the <code>@AsynchronousNonBlocking</code> annotation described in <a href="#async-nonblocking">@AsynchronousNonBlocking</a>, because the method doesn&#8217;t block and offloading execution to another thread is not necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Returning the <code>Uni</code> type from Mutiny.
This shows that whatever works for <code>CompletionStage</code> also works for the other async types.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation internally converts the async types to a <code>CompletionStage</code> and back.
This means that to be able to use any particular asynchronous type, the corresponding converter must be present.
SmallRye Fault Tolerance provides support libraries for popular asynchronous types, and these support libraries include the corresponding converters.</p>
</div>
<div class="paragraph">
<p>It is possible that the runtime you use already provides the correct integration.
Otherwise, add a dependency to your application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://smallrye.io/smallrye-mutiny/">Mutiny</a>: <code>io.smallrye:smallrye-fault-tolerance-mutiny</code></p>
</li>
<li>
<p><a href="https://github.com/ReactiveX/RxJava/tree/3.x">RxJava 3</a>: <code>io.smallrye:smallrye-fault-tolerance-rxjava3</code></p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Quarkus</div>
<div class="paragraph">
<p>In Quarkus, the Mutiny support library is present by default.
You can use fault tolerance on methods that return <code>Uni</code> out of the box.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backoff_strategies_for_retry"><a class="anchor" href="#_backoff_strategies_for_retry"></a>Backoff Strategies for <code>@Retry</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>When retrying failed operations, it is often useful to make a delay between retry attempts.
This delay is also called "backoff".
The <code>@Retry</code> annotation in MicroProfile Fault Tolerance supports a single backoff strategy: constant.
That is, the delay between all retry attempts is identical (with the exception of a random jitter).</p>
</div>
<div class="paragraph">
<p>SmallRye Fault Tolerance offers 3 annotations to specify a different backoff strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@ExponentialBackoff</code></p>
</li>
<li>
<p><code>@FibonacciBackoff</code></p>
</li>
<li>
<p><code>@CustomBackoff</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One of these annotations may be present on any program element (method or class) that also has the <code>@Retry</code> annotation.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example;

@ApplicationScoped
public class MyService {
    @Retry
    @ExponentialBackoff
    public void hello() {
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is an error to add a backoff annotation to a program element that doesn&#8217;t have <code>@Retry</code> (e.g. add <code>@Retry</code> on a class and <code>@ExponentialBackoff</code> on a method).
It is also an error to add more than one of these annotations to the same program element.</p>
</div>
<div class="paragraph">
<p>When any one of these annotations is present, it modifies the behavior specified by the <code>@Retry</code> annotation.
The new behavior is as follows:</p>
</div>
<div class="paragraph">
<p>For <code>@ExponentialBackoff</code>, the delays between retry attempts grow exponentially, using a defined <code>factor</code>.
By default, the <code>factor</code> is 2, so each delay is 2 * the previous delay.
For example, if the initial delay (specified by <code>@Retry</code>) is 1 second, then the second delay is 2 seconds, third delay is 4 seconds, fourth delay is 8 seconds etc.
It is possible to define a <code>maxDelay</code>, so that this growth has a limit.</p>
</div>
<div class="paragraph">
<p>For <code>@FibonacciBackoff</code>, the delays between retry attempts grow per the Fibonacci sequence.
For example, if the initial delay (specified by <code>@Retry</code>) is 1 second, then the second delay is 2 seconds, third delay is 3 seconds, fourth delay is 5 seconds etc.
It is possible to define a <code>maxDelay</code>, so that this growth has a limit.</p>
</div>
<div class="paragraph">
<p>Both <code>@ExponentialBackoff</code> and <code>@FibonacciBackoff</code> also apply jitter, exactly like plain <code>@Retry</code>.</p>
</div>
<div class="paragraph">
<p>Also, since <code>@Retry</code> has a default <code>maxDuration</code> of 3 minutes and default <code>maxRetries</code> of 3, both <code>@ExponentialBackoff</code> and <code>@FibonacciBackoff</code> define a <code>maxDelay</code> of 1 minute.
If we redefine <code>maxRetries</code> to a much higher value, and the guarded method keeps failing, the delay would eventually become higher than 1 minute.
In that case, it will be limited to 1 minute.
Of course, <code>maxDelay</code> can be configured.
If set to <code>0</code>, there&#8217;s no limit, and the delays will grow without bounds.</p>
</div>
<div class="paragraph">
<p>For <code>@CustomBackoff</code>, computing the delays between retry attempts is delegated to a specified implementation of <code>CustomBackoffStrategy</code>.
This is an advanced option.</p>
</div>
<div class="paragraph">
<p>For more information about these backoff strategies, see the javadoc of the annotations.</p>
</div>
<div class="sect2">
<h3 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h3>
<div class="paragraph">
<p>These annotations may be configured using the same mechanism as MicroProfile Fault Tolerance annotations.
For example, to modify the <code>factor</code> of the <code>@ExponentialBackoff</code> annotation above, you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">com.example.MyService/hello/ExponentialBackoff/factor=3</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metrics"><a class="anchor" href="#_metrics"></a>Metrics</h3>
<div class="paragraph">
<p>These annotations do not have any special metrics.
All <code>@Retry</code> metrics are still present and reflect the altered behavior.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="noncompatible-mode"><a class="anchor" href="#noncompatible-mode"></a>Non-compatible Mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SmallRye Fault Tolerance offers a mode where certain features are improved beyond specification, as described below.
This mode is <strong>not compatible</strong> with the MicroProfile Fault Tolerance specification (and doesn&#8217;t necessarily pass the entire TCK).</p>
</div>
<div class="paragraph">
<p>This mode is disabled by default.
To enable, set the configuration property <code>smallrye.faulttolerance.mp-compatibility</code> to <code>false</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Quarkus</div>
<div class="paragraph">
<p>In Quarkus, the non-compatible mode is enabled by default.
To restore compatibility, add the following to your <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">smallrye.faulttolerance.mp-compatibility=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the non-compatible mode is available since SmallRye Fault Tolerance 5.2.0 and Quarkus 2.1.0.Final.
Previous versions are always compatible.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="method-asynchrony"><a class="anchor" href="#method-asynchrony"></a>Determining Asynchrony from Method Signature</h3>
<div class="paragraph">
<p>In the non-compatible mode, method asynchrony is determined solely from its signature.
That is, methods that</p>
</div>
<div class="ulist">
<ul>
<li>
<p>have some fault tolerance annotation (such as <code>@Retry</code>),</p>
</li>
<li>
<p>return <code>CompletionStage</code> (or some other <a href="#async-types">async type</a>),</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>always have asynchronous fault tolerance applied.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Retry
    CompletionStage&lt;String&gt; hello() { <i class="conum" data-value="1"></i><b>(1)</b>
        ...
    }

    @Retry
    Uni&lt;String&gt; helloMutiny() { <i class="conum" data-value="2"></i><b>(2)</b>
        ...
    }

    @Retry
    @Asynchronous
    CompletionStage&lt;String&gt; helloBlocking() { <i class="conum" data-value="3"></i><b>(3)</b>
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Executed on the original thread, because the method returns <code>CompletionStage</code>.
It is as if the method was annotated <code>@AsynchronousNonBlocking</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Executed on the original thread, because the method returns an <a href="#async-types">async type</a>.
It is as if the method was annotated <code>@AsynchronousNonBlocking</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The explicit <code>@Asynchronous</code> annotation is honored.
The method is executed on a thread pool.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the existing annotations still work without a change, both in compatible and non-compatible mode.
That is, if a method (or class) is annotated <code>@Asynchronous</code>, execution will be offloaded to a thread pool.
If a method (or class) is annotated <code>@AsynchronousNonBlocking</code>, execution will happen on the original thread.</p>
</div>
<div class="paragraph">
<p>Also note that this doesn&#8217;t affect methods returning <code>Future</code>.
You still have to annotate them <code>@Asynchronous</code> to make sure they are executed on a thread pool and are guarded properly.
As mentioned in the <a href="#async-nonblocking">@AsynchronousNonBlocking</a> section, we discourage using these methods, because the only way to obtain the future value is blocking.</p>
</div>
</div>
<div class="sect2">
<h3 id="_inspecting_exception_cause_chains"><a class="anchor" href="#_inspecting_exception_cause_chains"></a>Inspecting Exception Cause Chains</h3>
<div class="paragraph">
<p>The <code>@CircuitBreaker</code>, <code>@Fallback</code> and <code>@Retry</code> annotations can be used to specify that certain exceptions should be treated as failures and others as successes.
This is limited to inspecting the actual exception that was thrown.
However, in many usecases, exceptions are wrapped and the exception the user wants to decide on is only present in the cause chain.</p>
</div>
<div class="paragraph">
<p>In the non-compatible mode, if the actual thrown exception isn&#8217;t known failure or known success, SmallRye Fault Tolerance inspects the cause chain.
To be specific, in case a <code>@Fallback</code> method throws an exception, the decision process is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>if the exception is assignable to one of the <code>skipOn</code> exceptions, fallback is skipped and the exception is rethrown;</p>
</li>
<li>
<p>otherwise, if the exception is assignable to one of the <code>applyOn</code> exceptions, fallback is applied;</p>
</li>
<li>
<p>otherwise, if the cause chain of the exception contains an exception assignable to one of the <code>skipOn</code> exceptions, fallback is skipped and the exception is rethrown;</p>
</li>
<li>
<p>otherwise, if the cause chain of the exception contains an exception assignable to one of the <code>applyOn</code> exceptions, fallback is applied;</p>
</li>
<li>
<p>otherwise, the exception is rethrown.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example, say we have this method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Fallback(fallbackMethod = "fallback",
    skipOn = ExpectedOutcomeException.class,
    applyOn = IOException.class)
public Result doSomething() {
    ...
}

public Result fallback() {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>doSomething</code> throws an <code>ExpectedOutcomeException</code>, fallback is skipped and the exception is thrown.
If <code>doSomething</code> throws an <code>IOException</code>, fallback is applied.
If <code>doSomething</code> throws a <code>WrapperException</code> whose cause is <code>ExpectedOutcomeException</code>, fallback is skipped and the exception is thrown.
If <code>doSomething</code> throws a <code>WrapperException</code> whose cause is <code>IOException</code>, fallback is applied.</p>
</div>
<div class="paragraph">
<p>Comparing with the <code>@Fallback</code> specification, SmallRye Fault Tolerance inserts 2 more steps into the decision process that inspect the cause chain.
Note that these steps are executed if and only if the thrown exception matches neither <code>skipOn</code> nor <code>applyOn</code>.
If the thrown exception matches either of them, the cause chain is not inspected at all.</p>
</div>
<div class="paragraph">
<p>Similar behavior applies to <code>@CircuitBreaker</code> and <code>@Retry</code>.
All 3 annotations follow the same principle: exceptions considered success have priority over those considered failure.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Fault Tolerance annotation</th>
<th class="tableblock halign-left valign-top">Exception is first tested against</th>
<th class="tableblock halign-left valign-top">and then against</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Fallback</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skipOn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>applyOn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@CircuitBreaker</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skipOn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>failOn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Retry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>abortOn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>retryOn</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_fallback_method_with_exception_parameter"><a class="anchor" href="#_fallback_method_with_exception_parameter"></a>Fallback Method with Exception Parameter</h3>
<div class="paragraph">
<p>In the non-compatible mode, SmallRye Fault Tolerance supports access to the causing exception in a <code>@Fallback</code> method.</p>
</div>
<div class="paragraph">
<p>A fallback method, as defind by the MicroProfile Fault Tolerance specification, must have the same parameters as the guarded method.
SmallRye Fault Tolerance permits defining one additional parameter, at the end of the parameter list, which must be of an exception type.
If such parameter is defined, the exception that caused the fallback will be supplied in it.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Fallback(fallbackMethod = "fallback")
    public String doSomething(String param) {
        ...
    }

    public String fallback(String param, IllegalArgumentException cause) { <i class="conum" data-value="1"></i><b>(1)</b>
        ...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The fallback method matches the guarded method signature, except for one additional parameter at the end.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All rules of MicroProfile Fault Tolerance specification related to looking up fallback methods still apply.
That is, the return types must match, the parameter types must match (with this one exception), etc.</p>
</div>
<div class="paragraph">
<p>If the thrown exception is not assignable to the exception parameter type, it is rethrown as if no fallback was declared.
In the previous example, if <code>IllegalStateException</code> was thrown, the fallback method would not be called, as <code>IllegalStateException</code> is not a subtype of <code>IllegalArgumentException</code>.</p>
</div>
<div class="paragraph">
<p>If the guarded method has a vararg parameter and you want to declare a fallback method with an exception parameter, simply replace the vararg syntax with an array type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Fallback(fallbackMethod = "fallback")
    public String doSomething(String... params) {
        ...
    }

    public String fallback(String[] params, IllegalArgumentException cause) {
        ...
    }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_fallback_methods_with_exception_parameter"><a class="anchor" href="#_multiple_fallback_methods_with_exception_parameter"></a>Multiple Fallback Methods with Exception Parameter</h4>
<div class="paragraph">
<p>It is possible to declare multiple overloads of the fallback method, each having different type of the exception parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Fallback(fallbackMethod = "fallback")
    public String doSomething(String param) {
        ...
    }

    public String fallback(String param, IllegalArgumentException cause) {
        ...
    }

    public String fallback(String param, RuntimeException cause) {
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that case, which fallback method is called depends on the type of thrown exception.
The method that declares a most-specific supertype of the actual exception is selected.</p>
</div>
<div class="paragraph">
<p>In the previous example, if <code>IllegalArgumentException</code> was thrown by <code>doSomething</code>, the first fallback method would be called.
If <code>IllegalStateException</code> was thrown, the second fallback method would be called.</p>
</div>
<div class="paragraph">
<p>If the thrown exception is not assignable to the exception parameter type of any fallback method, it is rethrown as if no fallback was declared.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fallback_methods_with_and_without_exception_parameter"><a class="anchor" href="#_fallback_methods_with_and_without_exception_parameter"></a>Fallback Methods with and without Exception Parameter</h4>
<div class="paragraph">
<p>It is possible to declare the fallback method with and without an exception parameter at the same time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Fallback(fallbackMethod = "fallback")
    public String doSomething(String param) {
        ...
    }

    public String fallback(String param, IllegalArgumentException cause) {
        ...
    }

    public String fallback(String param, RuntimeException cause) {
        ...
    }

    public String fallback(String param) {
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fallback methods with an exception parameter have precedence.
The fallback method without an exception parameter is only called if the thrown exception is not assignable to any declared exception parameter.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interactions_with_applyon_skipon"><a class="anchor" href="#_interactions_with_applyon_skipon"></a>Interactions with <code>applyOn</code> / <code>skipOn</code></h4>
<div class="paragraph">
<p>The presence or absence of a fallback method with specific exception parameter may seem related to the usage of <code>applyOn</code> / <code>skipOn</code> on the <code>@Fallback</code> annotation, but in fact, it is not.
These features are completely independent.</p>
</div>
<div class="paragraph">
<p>Simply put, the <code>applyOn</code> / <code>skipOn</code> configuration is always evaluated first.
A fallback method is only selected and invoked when this configuration indicates that a fallback should apply.</p>
</div>
<div class="paragraph">
<p>If <code>@Fallback</code> is configured to skip <code>IllegalStateException</code> and <code>IllegalStateException</code> is thrown, no fallback method is invoked.
That applies even if a fallback method with a matching exception parameter exists.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @Fallback(fallbackMethod = "fallback", skipOn = IllegalStateException.class)
    public String doSomething(String param) {
        ...
    }

    public String fallback(String param, IllegalArgumentException cause) {
        ...
    }

    public String fallback(String param, RuntimeException cause) {
        ...
    }

    public String fallback(String param) {
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if <code>doSomething</code> throws <code>IllegalArgumentException</code>, the first fallback method is called;</p>
</li>
<li>
<p>if <code>doSomething</code> throws <code>IllegalStateException</code>, no fallback method is called, because this exception type is skipped;</p>
</li>
<li>
<p>if <code>doSomething</code> throws any other <code>RuntimeException</code>, the second fallback method is called;</p>
</li>
<li>
<p>if <code>doSomething</code> throws any other exception, the last fallback method is called.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kotlin-suspend-functions"><a class="anchor" href="#kotlin-suspend-functions"></a>Kotlin <code>suspend</code> Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SmallRye Fault Tolerance includes support for Kotlin suspending functions.
They are treated as <a href="#async-types">Additional Asynchronous Types</a>, even though the internal implementation is more complex than support for Mutiny or RxJava.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@ApplicationScoped
open class MyService {
    @Retry(maxRetries = 2)
    @Fallback(fallbackMethod = "helloFallback")
    open suspend fun hello(): String { <i class="conum" data-value="1"></i><b>(1)</b>
        delay(100)
        throw IllegalArgumentException()
    }

    private suspend fun helloFallback(): String { <i class="conum" data-value="2"></i><b>(2)</b>
        delay(100)
        return "hello"
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As a suspending function, this method can only be called from another suspending function.
It will be guarded by the retry and fallback strategies, as defined using the annotations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Similarly to fallback methods in Java, fallback methods in Kotlin must have the same signature as the guarded method.
Since the guarded method is suspending, the fallback method must be suspending.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As mentioned above, suspending functions are treated as async types.
This means that for asynchronous fault tolerance to work correctly on suspending functions, they must be determined to be asynchronous.
That happens automatically in the <a href="#method-asynchrony">non-compatible mode</a>, based on the method signature, but if you use strictly compatible mode, the <code>@Asynchronous</code> or <code>@AsynchronousNonBlocking</code> annotation must be present.
It is expected that most users will use the Kotlin support in the non-compatible mode, so the example above does not include any such annotation.</p>
</div>
<div class="paragraph">
<p>To be able to use this, a support library must be present.
It is possible that the runtime you use already provides the correct integration.
Otherwise, add a dependency to your application: <code>io.smallrye:smallrye-fault-tolerance-kotlin</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Quarkus</div>
<div class="paragraph">
<p>In Quarkus, the Kotlin support library is present by default, if you use the Quarkus Kotlin support.
You can declare fault tolerance annotations on suspending methods out of the box.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_programmatic_api"><a class="anchor" href="#_programmatic_api"></a>Programmatic API</h3>
<div class="paragraph">
<p>Suspending functions are currently only supported in the declarative, annotation-based API, as shown in the example above.
The <a href="programmatic-api.html" class="page">Programmatic API</a> of SmallRye Fault Tolerance does not support suspending functions, but other than that, it can of course be used from Kotlin through its Java interop.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reusable_preconfigured_fault_tolerance"><a class="anchor" href="#_reusable_preconfigured_fault_tolerance"></a>Reusable, Preconfigured Fault Tolerance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The declarative, annotation-based API of MicroProfile Fault Tolerance doesn&#8217;t allow sharing configuration of fault tolerance strategies across multiple classes.
In a single class, the configuration may be shared across all methods by putting the annotations on the class instead of individual methods, but even then, <em>stateful</em> fault tolerance strategies are not shared.
Each method has its own bulkhead and/or circuit breaker, which is often not what you want.</p>
</div>
<div class="paragraph">
<p>The <a href="programmatic-api.html" class="page">programmatic API</a> of SmallRye Fault Tolerance allows using a single <code>FaultTolerance</code> object to guard multiple disparate actions, which allows reuse and state sharing.
It is possible to use a programmatically constructed <code>FaultTolerance</code> object declaratively, using the <code>@ApplyFaultTolerance</code> annotation.</p>
</div>
<div class="paragraph">
<p>To be able to do that, we need a bean of type <code>FaultTolerance</code> with the <code>@Identifier</code> qualifier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PreconfiguredFaultTolerance {
    @Produces
    @Identifier("my-fault-tolerance")
    public static final FaultTolerance&lt;String&gt; FT = FaultTolerance.&lt;String&gt;create()
            .withRetry().maxRetries(2).done()
            .withFallback().handler(() -&gt; "fallback").done()
            .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="programmatic-api.html" class="page">programmatic API</a> documentation for more information about creating the <code>FaultTolerance</code> instance.</p>
</div>
<div class="paragraph">
<p>It is customary to create the bean by declaring a <code>static</code> producer field, just like in the previous example.</p>
</div>
<div class="paragraph">
<p>Once we have that, we can apply <code>my-fault-tolerance</code> to synchronous methods that return <code>String</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class MyService {
    @ApplyFaultTolerance("my-fault-tolerance")
    public String doSomething() {
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to create a bean of type <code>FaultTolerance&lt;Object&gt;</code> and apply it to synchronous methods that return many different types.
Note that this effectively precludes defining a useful fallback, because fallback can only be defined when the value type is known.</p>
</div>
<div class="paragraph">
<p>It is also possible to define a bean of type <code>FaultTolerance&lt;CompletionStage&lt;T&gt;&gt;</code> and apply it to asynchronous methods that return <code>CompletionStage&lt;T&gt;</code>.
Likewise, it is possible to do this for <a href="#async-types">Additional Asynchronous Types</a>.</p>
</div>
<div class="paragraph">
<p>Note that you can&#8217;t define a synchronous <code>FaultTolerance&lt;T&gt;</code> object and apply it to any asynchronous method.
Similarly, you can&#8217;t define an asynchronous <code>FaultTolerance&lt;CompletionStage&lt;T&gt;&gt;</code> and apply it to a synchronous method or an asynchronous method with different <a href="#async-types">asynchronous type</a>.
This limitation will be lifted in the future.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rate_limit"><a class="anchor" href="#_rate_limit"></a>Rate Limit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SmallRye Fault Tolerance includes an additional fault tolerance strategy, not prescribed by the MicroProfile Fault Tolerance specification: <em>rate limit</em>.</p>
</div>
<div class="paragraph">
<p>Rate limit enforces a maximum number of permitted invocations in a time window of some length.
For example, with a rate limit, one can make sure that a method may only be called 50 times per minute.
Invocations that would exceed the limit are rejected with an exception of type <code>RateLimitException</code>.</p>
</div>
<div class="paragraph">
<p>Additionally, it is possible to define minimum spacing between invocations.
For example, with minimum spacing of 1 second, if a second invocation happens 500 millis after the first, it is rejected even if the limit wouldn&#8217;t be exceeded yet.</p>
</div>
<div class="paragraph">
<p>Rate limit is superficially similar to a bulkhead (concurrency limit), but is in fact quite different.
Bulkhead limits the number of executions happening concurrently at any point in time.
Rate limit limits the number of executions in a time window of some length, without considering concurrency.</p>
</div>
<div class="sect2">
<h3 id="_rate_limit_usage"><a class="anchor" href="#_rate_limit_usage"></a>Rate Limit Usage</h3>
<div class="paragraph">
<p>A method or a class can be annotated with <code>@RateLimit</code>, which means the method or the methods in the class will apply the rate limit strategy.</p>
</div>
<div class="paragraph">
<p>The following annotation members control the rate limit behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>value</code>: the limit of maximum invocations to be permitted in the time window;</p>
</li>
<li>
<p><code>window</code> and <code>windowUnit</code>: the length of the time window;</p>
</li>
<li>
<p><code>minSpacing</code> and <code>minSpacingUnit</code>: the minimum spacing between two consecutive invocations;</p>
</li>
<li>
<p><code>type</code>: the type of time windows used for rate limiting, described below.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The previous example with 50 maximum invocations per minute and minimum spacing of 1 second would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RateLimit(value = 50,
        window = 1, windowUnit = ChronoUnit.MINUTES,
        minSpacing = 1, minSpacingUnit = ChronoUnit.SECONDS)
public void doSomething() {
    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_time_window_type"><a class="anchor" href="#_time_window_type"></a>Time Window Type</h3>
<div class="paragraph">
<p>SmallRye Fault Tolerance supports three types of a time window used for rate limiting: <em>fixed</em>, <em>rolling</em> and <em>smooth</em>.</p>
</div>
<div class="paragraph">
<p>Fixed time windows are a result of dividing time into non-overlapping intervals of given length.
The invocation limit is enforced for each interval independently.
This means that short bursts of invocations occuring near the time window boundaries may temporarily exceed the configured rate limit.
This kind of rate limiting is also called <em>fixed window</em> rate limiting.</p>
</div>
<div class="paragraph">
<p>Rolling time windows enforce the limit continuously, instead of dividing time into independent intervals.
The invocation limit is enforced for all possible time intervals of given length, regardless of overlap.
This is more precise, but requires more memory and may be slower.
This kind of rate limiting is also called <em>sliding log</em> rate limiting.</p>
</div>
<div class="paragraph">
<p>Smooth time windows enforce a uniform distribution of invocations under a rate calculated from given time window length and given limit.
If recent rate of invocations is under the limit, a subsequent burst of invocations is allowed during a shorter time span, but the calculated rate is never exceeded.
This kind of rate limiting is also called <em>token bucket</em> or <em>leaky bucket (as a meter)</em> rate limiting, with the additional property that all work units are considered to have the same size.</p>
</div>
<div class="paragraph">
<p>The type of time window used for rate limiting is configured using the <code>type</code> annotation member:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RateLimit(value = 50,
        window = 1, windowUnit = ChronoUnit.MINUTES,
        minSpacing = 1, minSpacingUnit = ChronoUnit.SECONDS,
        type = RateLimitType.ROLLING)
public void doSomething() {
    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lifecycle"><a class="anchor" href="#_lifecycle"></a>Lifecycle</h3>
<div class="paragraph">
<p>Rate limit needs to maintain some state between invocations, depending on the time window type.
It may be the number of recent invocations or the time stamp of last invocation.
This state is a singleton, irrespective of the lifecycle of the bean that uses the <code>@RateLimit</code> annotation.</p>
</div>
<div class="paragraph">
<p>More specifically, the rate limit state is uniquely identified by the combination of the bean class (<code>java.lang.Class</code>) and the method object (<code>java.lang.reflect.Method</code>) representing the guarded method.</p>
</div>
<div class="paragraph">
<p>For example, if there’s a guarded method <code>doWork</code> on a bean which is <code>@RequestScoped</code>, each request will have its own instance of the bean, but all invocations of <code>doWork</code> will share the same rate limit state.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interactions_with_other_annotations"><a class="anchor" href="#_interactions_with_other_annotations"></a>Interactions with Other Annotations</h3>
<div class="paragraph">
<p>The <code>@RateLimit</code> annotation can be used together with all other fault tolerance annotations.
If a method would hypothetically declare all fault tolerance annotations, the fault tolerance strategies would be nested like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>Fallback(
    Retry(
        CircuitBreaker(
            RateLimit(
                Timeout(
                    Bulkhead(
                        ... the guarded method ...
                    )
                )
            )
        )
    )
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>@Fallback</code> is used with <code>@RateLimit</code>, the fallback method or handler may be invoked if a <code>RateLimitException</code> is thrown, depending on the fallback configuration.</p>
</div>
<div class="paragraph">
<p>If <code>@Retry</code> is used with <code>@RateLimit</code>, each retry attempt is processed by the rate limit as an independent invocation.
If <code>RateLimitException</code> is thrown, the execution may be retried, depending on how retry is configured.</p>
</div>
<div class="paragraph">
<p>If <code>@CircuitBreaker</code> is used with <code>@RateLimit</code>, the circuit breaker is checked before enforcing the rate limit.
If rate limiting results in <code>RateLimitException</code>, this may be counted as a failure, depending on how the circuit breaker is configured.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_2"><a class="anchor" href="#_configuration_2"></a>Configuration</h3>
<div class="paragraph">
<p>The configuration system of MicroProfile Fault Tolerance applies to <code>@RateLimit</code> without a change.</p>
</div>
<div class="paragraph">
<p>For example, assume the following class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.example;

@ApplicationScoped
public class MyService {
    @RateLimit(value = 50,
            window = 1, windowUnit = ChronoUnit.MINUTES,
            minSpacing = 1, minSpacingUnit = ChronoUnit.SECONDS)
    public void doSomething() {
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rate limit configured for the <code>doSomething</code> method may be reconfigured like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">com.example.MyService/doSomething/RateLimit/value=150</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metrics_2"><a class="anchor" href="#_metrics_2"></a>Metrics</h3>
<div class="paragraph">
<p>Rate limit exposes metrics to MicroProfile Metrics, following other MicroProfile Fault Tolerance metrics.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ft.ratelimit.calls.total</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Counter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of times the rate limit logic was run. This will usually be once per method call, but may be zero times if the circuit breaker prevented execution or more than once if the method call is retried.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tags</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>method</code> - the fully qualified method name</p>
</li>
<li>
<p><code>rateLimitResult</code> = <code>[permitted|rejected]</code> - whether the rate limit permitted the method call</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Micrometer is of course also supported, as described in <a href="basic.html#metrics" class="page">Metrics</a>.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="basic.html">Basic Usage</a></span>
  <span class="next"><a href="programmatic-api.html">Programmatic API</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>
    Sponsored by <a href="https://www.redhat.com"><img style="vertical-align: middle; height: 2.5em;" src="../../../_/img/redhat.svg" alt="Red Hat"></a>
  </p>
  <p>
    Made with <a href="https://github.com/smallrye/smallrye-antora-ui">SmallRye Antora UI</a>, which is licensed under the MPL-2.0 license.
    Includes portions of <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a>, which is licensed under the MIT license.
  </p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
